# OAuth2 Complete Flow - Step by Step with Code References

> **Complete control flow from clicking "Sign in with Google" to database entry and successful login**

---

## ğŸ“‹ Table of Contents
1. [User Clicks "Sign in with Google" Button](#step-1-user-clicks-sign-in-with-google-button)
2. [Browser Redirects to OAuth2 Authorization Endpoint](#step-2-browser-redirects-to-oauth2-authorization-endpoint)
3. [Spring Security Intercepts and Redirects to Google](#step-3-spring-security-intercepts-and-redirects-to-google)
4. [User Authenticates with Google](#step-4-user-authenticates-with-google)
5. [Google Redirects Back with Authorization Code](#step-5-google-redirects-back-with-authorization-code)
6. [Spring Security Exchanges Code for Access Token](#step-6-spring-security-exchanges-code-for-access-token)
7. [CustomOAuth2UserService Loads User Details](#step-7-customoauth2userservice-loads-user-details)
8. [User Entity Created/Updated in Database](#step-8-user-entity-createdupdated-in-database)
9. [OAuth2 Success Handler Generates JWT](#step-9-oauth2-success-handler-generates-jwt)
10. [Browser Receives JWT and Redirects to Dashboard](#step-10-browser-receives-jwt-and-redirects-to-dashboard)

---

## Step 1: User Clicks "Sign in with Google" Button

### ğŸ“ Location
**File:** `/src/main/resources/static/login.html`  
**Lines:** 66-75

### ğŸ“ Code
```html
<button onclick="loginWithGoogle()"
    class="mt-4 w-full flex items-center justify-center gap-3 bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 rounded-lg border-2 border-gray-300 transition duration-200">
    <svg class="w-5 h-5" viewBox="0 0 24 24">
        <!-- Google logo SVG paths -->
    </svg>
    Sign in with Google
</button>

<script>
function loginWithGoogle() {
    window.location.href = `${API_BASE}/oauth2/authorize/google`;
}
</script>
```

### ğŸ”„ When Called
- User clicks the "Sign in with Google" button on login page

### ğŸ“Š Parameter Values
- `API_BASE` = `window.location.origin` â†’ e.g., `http://localhost:8080`
- Redirect URL: `http://localhost:8080/oauth2/authorize/google`

### â­ï¸ What Happens Next
- Browser navigates to `/oauth2/authorize/google`
- HTTP GET request sent to Spring Boot backend

---

## Step 2: Browser Redirects to OAuth2 Authorization Endpoint

### ğŸ“ Location
**File:** `/src/main/java/com/learning/security/configs/WebSecurityConfig.java`  
**Lines:** 223-233

### ğŸ“ Code
```java
.oauth2Login(oauth2 -> oauth2
    .authorizationEndpoint(authorization -> authorization
        .baseUri("/oauth2/authorize"))
    .redirectionEndpoint(redirection -> redirection
        .baseUri("/login/oauth2/code/*"))
    .userInfoEndpoint(userInfo -> userInfo
        .userService(customOAuth2UserService))
    .successHandler(oAuth2AuthenticationSuccessHandler)
    .failureHandler(oAuth2AuthenticationFailureHandler)
)
```

### ğŸ”„ When Called
- Spring Security automatically handles `/oauth2/authorize/google` endpoint
- Triggered by the browser GET request from Step 1

### ğŸ“Š Parameter Values
- `baseUri`: `/oauth2/authorize` - matches the URL pattern
- `registrationId`: `google` - extracted from URL path
- Configuration loaded from `application-dev.yml`

### â­ï¸ What Happens Next
- Spring Security reads OAuth2 configuration for Google
- Constructs Google authorization URL with required parameters

---

## Step 3: Spring Security Intercepts and Redirects to Google

### ğŸ“ Location
**File:** `/src/main/resources/application-dev.yml`  
**Lines:** 21-39

### ğŸ“ Configuration
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope:
              - email
              - profile
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            client-name: Google
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
            user-name-attribute: sub
```

### ğŸ”„ When Called
- Spring Security's OAuth2 filter reads this configuration
- Automatically triggered after Step 2

### ğŸ“Š Parameter Values Constructed
Spring Security builds this URL:
```
https://accounts.google.com/o/oauth2/v2/auth
  ?client_id=<client_id>
  &redirect_uri=http://localhost:8080/login/oauth2/code/google
  &response_type=code
  &scope=email profile
  &state=<random_state_token>
```

- `client_id`: From environment variable `GOOGLE_CLIENT_ID`
- `redirect_uri`: `http://localhost:8080/login/oauth2/code/google`
- `scope`: `email profile`
- `state`: Random CSRF token generated by Spring Security

### â­ï¸ What Happens Next
- User's browser redirected to Google's login page
- User sees Google account selection screen

---

## Step 4: User Authenticates with Google

### ğŸ“ Location
**External:** Google's OAuth2 Server

### ğŸ”„ When Called
- After redirect from Step 3
- Google displays account picker and permission consent screen

### ğŸ“Š User Actions
1. User selects Google account
2. Reviews requested permissions (email, profile)
3. Clicks "Allow" to grant access

### â­ï¸ What Happens Next
- Google generates authorization code
- Google redirects back to your application with code

---

## Step 5: Google Redirects Back with Authorization Code

### ğŸ“ Redirect URL Pattern
**URL:** `http://localhost:8080/login/oauth2/code/google?code=<authorization_code>&state=<state>`

### ğŸ“Š Parameters Received
```
GET /login/oauth2/code/google
  ?code=4/0AeanS0asFw9xKj8... (authorization code from Google)
  &state=etc123... (same state token from Step 3)
```

### ğŸ”„ When Called
- Automatically by Google after user grants permission
- Browser redirected by Google OAuth2 server

### â­ï¸ What Happens Next
- Spring Security's OAuth2 filter intercepts this redirect
- Validates the `state` parameter (CSRF protection)
- Prepares to exchange authorization code for access token

---

## Step 6: Spring Security Exchanges Code for Access Token

### ğŸ“ Location
**Framework:** Spring Security OAuth2 Client (internal)  
**Configuration:** `/src/main/resources/application-dev.yml` line 36

### ğŸ”„ When Called
- Automatically by Spring Security after receiving authorization code
- Happens behind the scenes (handled by `DefaultAuthorizationCodeTokenResponseClient`)

### ğŸ“Š HTTP Request Made by Spring Security
```http
POST https://oauth2.googleapis.com/token
Content-Type: application/x-www-form-urlencoded

code=4/0AeanS0asFw9xKj8...
&client_id=<client_id>
&client_secret=<client_secret>
&redirect_uri=http://localhost:8080/login/oauth2/code/google
&grant_type=authorization_code
```

### ğŸ“Š Response from Google
```json
{
  "access_token": "ya29.a0AfH6SMBx...",
  "expires_in": 3599,
  "token_type": "Bearer",
  "scope": "email profile openid",
  "id_token": "eyJhbGciOiJSUzI1NiIs..."
}
```

### â­ï¸ What Happens Next
- Spring Security receives access token
- Makes another request to fetch user information using the access token
- Calls `CustomOAuth2UserService.loadUser()`

---

## Step 7: CustomOAuth2UserService Loads User Details

### ğŸ“ Location
**File:** `/src/main/java/com/learning/security/services/CustomOAuth2UserService.java`

### ğŸ“ Code - Main Entry Point
**Method:** `loadUser(OAuth2UserRequest userRequest)`  
**Lines:** 43-54

```java
@Override
public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
    OAuth2User oAuth2User = super.loadUser(userRequest);

    try {
        return processOAuth2User(userRequest, oAuth2User);
    } catch (AuthenticationException ex) {
        throw ex;
    } catch (Exception ex) {
        throw new InternalAuthenticationServiceException(ex.getMessage(), ex.getCause());
    }
}
```

### ğŸ”„ When Called
- **Automatically by Spring Security** after receiving access token (Step 6)
- Spring Security calls `super.loadUser(userRequest)` first to fetch user data from Google

### ğŸ“Š Parameter Values
**Input Parameter:** `userRequest` (OAuth2UserRequest)
- `userRequest.getAccessToken()` â†’ Access token from Step 6
- `userRequest.getClientRegistration()` â†’ Google client configuration
- `userRequest.getClientRegistration().getRegistrationId()` â†’ `"google"`

**After `super.loadUser(userRequest)`:** `oAuth2User` (OAuth2User)
```java
// Google returns these attributes:
{
  "sub": "117355461831405973524",           // Google user ID
  "name": "M. Yousuf",
  "given_name": "John",
  "family_name": "Doe",
  "picture": "https://lh3.googleusercontent.com/...",
  "email": "m.yousuf@gmail.com",
  "email_verified": true,
  "locale": "en"
}
```

### â­ï¸ What Happens Next
- Calls `processOAuth2User(userRequest, oAuth2User)`

---

### ğŸ“ Code - Process OAuth2 User
**Method:** `processOAuth2User(OAuth2UserRequest, OAuth2User)`  
**Lines:** 56-85

```java
private OAuth2User processOAuth2User(OAuth2UserRequest userRequest, OAuth2User oAuth2User) {
    OAuth2UserInfo oAuth2UserInfo = getOAuth2UserInfo(
        userRequest.getClientRegistration().getRegistrationId(), 
        oAuth2User.getAttributes()
    );

    if (!StringUtils.hasText(oAuth2UserInfo.getEmail())) {
        throw new OAuth2AuthenticationProcessingException("Email not found from OAuth2 provider");
    }

    Optional<User> userOptional = userRepo.findByEmail(oAuth2UserInfo.getEmail());
    User user;
    
    if (userOptional.isPresent()) {
        user = userOptional.get();
        AuthProvider provider = AuthProvider.valueOf(
            userRequest.getClientRegistration().getRegistrationId().toUpperCase()
        );
        
        if (!user.getProvider().equals(provider)) {
            throw new OAuth2AuthenticationProcessingException(
                "Looks like you're signed up with " + user.getProvider() + 
                " account. Please use your " + user.getProvider() + " account to login."
            );
        }
        user = updateExistingUser(user, oAuth2UserInfo);
    } else {
        user = registerNewUser(userRequest, oAuth2UserInfo);
    }

    return UserDetailsImpl.build(user, oAuth2User.getAttributes());
}
```

### ğŸ”„ When Called
- Called by `loadUser()` method above

### ğŸ“Š Parameter Values
- `userRequest.getClientRegistration().getRegistrationId()` â†’ `"google"`
- `oAuth2User.getAttributes()` â†’ Map with Google user data (shown above)

### ğŸ“Š Flow Logic
1. **Extract User Info:** Calls `getOAuth2UserInfo()` to parse Google attributes
2. **Check Email:** Validates email exists
3. **Database Lookup:** `userRepo.findByEmail(email)` â†’ checks if user exists
4. **Branch:**
   - **User EXISTS:** 
     - Validates provider matches (Google vs LOCAL)
     - Calls `updateExistingUser()` to update profile picture
   - **User DOES NOT EXIST:** 
     - Calls `registerNewUser()` to create new database entry

### â­ï¸ What Happens Next
- If new user: Step 8 (Register New User)
- If existing user: Update existing user
- Finally: Build `UserDetailsImpl` object

---

### ğŸ“ Code - Get OAuth2 User Info
**Method:** `getOAuth2UserInfo(String registrationId, Map<String, Object> attributes)`  
**Lines:** 87-95

```java
private OAuth2UserInfo getOAuth2UserInfo(String registrationId, Map<String, Object> attributes) {
    if (registrationId.equalsIgnoreCase("google")) {
        return new GoogleOAuth2UserInfo(attributes);
    } else {
        throw new OAuth2AuthenticationProcessingException(
            "Sorry! Login with " + registrationId + " is not supported yet."
        );
    }
}
```

### ğŸ”„ When Called
- Called by `processOAuth2User()` at the very beginning

### ğŸ“Š Parameter Values
- `registrationId` â†’ `"google"`
- `attributes` â†’ Map with Google user data

### ğŸ“Š Returns
**Object:** `GoogleOAuth2UserInfo` (wrapper around Google attributes)

**File:** `/src/main/java/com/learning/security/models/GoogleOAuth2UserInfo.java`

```java
public class GoogleOAuth2UserInfo extends OAuth2UserInfo {
    
    public GoogleOAuth2UserInfo(Map<String, Object> attributes) {
        super(attributes);
    }

    @Override
    public String getId() {
        return (String) attributes.get("sub");  // "117355461831405973524"
    }

    @Override
    public String getName() {
        return (String) attributes.get("name");  // "M. Yousuf"
    }

    @Override
    public String getEmail() {
        return (String) attributes.get("email");  // "m.yousuf@gmail.com"
    }

    @Override
    public String getImageUrl() {
        return (String) attributes.get("picture");  // "https://lh3.googleusercontent.com/..."
    }
}
```

### â­ï¸ What Happens Next
- Returns `GoogleOAuth2UserInfo` object with extracted values
- Flow continues in `processOAuth2User()`

---

## Step 8: User Entity Created/Updated in Database

### ğŸ“ Code - Register New User
**File:** `/src/main/java/com/learning/security/services/CustomOAuth2UserService.java`  
**Method:** `registerNewUser(OAuth2UserRequest, OAuth2UserInfo)`  
**Lines:** 97-119

```java
private User registerNewUser(OAuth2UserRequest userRequest, OAuth2UserInfo oAuth2UserInfo) {
    User user = new User();
    
    AuthProvider provider = AuthProvider.valueOf(
        userRequest.getClientRegistration().getRegistrationId().toUpperCase()
    );
    
    user.setProvider(provider);
    user.setProviderId(oAuth2UserInfo.getId());
    user.setEmail(oAuth2UserInfo.getEmail());
    user.setImageUrl(oAuth2UserInfo.getImageUrl());
    user.setEmailVerified(true);
    user.setPassword(""); // No password for OAuth2 users
    
    // Assign default role
    Role userRole = roleRepo.findByName("ROLE_CUSTOMER")
        .orElseThrow(() -> new RuntimeException("Error: Role is not found."));
    user.setRole(userRole);
    
    return userRepo.save(user);
}
```

### ğŸ”„ When Called
- Called by `processOAuth2User()` if user does NOT exist in database

### ğŸ“Š Parameter Values
**Input:**
- `userRequest.getClientRegistration().getRegistrationId()` â†’ `"google"`
- `oAuth2UserInfo.getId()` â†’ `"117355461831405973524"` (Google sub)
- `oAuth2UserInfo.getEmail()` â†’ `"m.yousuf@gmail.com"`
- `oAuth2UserInfo.getImageUrl()` â†’ `"https://lh3.googleusercontent.com/..."`

**User Object Created:**
```java
User {
    id: null (auto-generated by database)
    email: "m.yousuf@gmail.com"
    password: "" (empty for OAuth2 users)
    provider: AuthProvider.GOOGLE
    providerId: "117355461831405973524"
    imageUrl: "https://lh3.googleusercontent.com/..."
    emailVerified: true
    isLocked: false (default)
    role: Role {
        id: 3
        name: "ROLE_CUSTOMER"
    }
}
```

### ğŸ“Š Database Query Executed
```sql
-- First: Find role
SELECT * FROM role WHERE name = 'ROLE_CUSTOMER';

-- Then: Insert new user
INSERT INTO users (email, password, provider, provider_id, image_url, email_verified, is_locked, role_id)
VALUES ('m.yousuf@gmail.com', '', 'GOOGLE', '117355461831405973524', 
        'https://lh3.googleusercontent.com/...', true, false, 3);
```

### â­ï¸ What Happens Next
- User entity saved to database with auto-generated ID
- Returns saved `User` object
- Flow returns to `processOAuth2User()` which calls `UserDetailsImpl.build(user, attributes)`

---

### ğŸ“ Code - Build UserDetailsImpl
**File:** `/src/main/java/com/learning/security/services/UserDetailsImpl.java`  
**Method:** `build(User user, Map<String, Object> attributes)`  
**Lines:** 119-123

```java
public static UserDetailsImpl build(User user, Map<String, Object> attributes) {
    UserDetailsImpl userDetails = build(user);
    userDetails.setAttributes(attributes);
    return userDetails;
}

// Calls this method first:
public static UserDetailsImpl build(User user) {
    List<GrantedAuthority> authorities = List.of(
        new SimpleGrantedAuthority(user.getRole().getName())
    );

    return new UserDetailsImpl(
        user.getId(),              // 15
        user.getEmail(),           // "m.yousuf@gmail.com"
        user.getEmail(),           // username = email
        user.getPassword(),        // "" (empty for OAuth2)
        true,                      // active
        user.getIsLocked() != null ? user.getIsLocked() : false,  // false
        null,                      // attributes (set next)
        authorities               // [SimpleGrantedAuthority("ROLE_CUSTOMER")]
    );
}
```

### ğŸ”„ When Called
- Called at the end of `processOAuth2User()` method

### ğŸ“Š Parameter Values
**Input:**
- `user` â†’ The saved User entity from database (with auto-generated ID)
- `attributes` â†’ Original Google OAuth2 attributes map

**Output:** `UserDetailsImpl` object
```java
UserDetailsImpl {
    id: 15
    username: "m.yousuf@gmail.com"
    email: "m.yousuf@gmail.com"
    password: ""
    active: true
    isLocked: false
    attributes: {
        "sub": "117355461831405973524",
        "name": "M. Yousuf",
        "email": "m.yousuf@gmail.com",
        "picture": "https://lh3.googleusercontent.com/..."
    }
    roles: [SimpleGrantedAuthority("ROLE_CUSTOMER")]
}
```

### â­ï¸ What Happens Next
- Returns `UserDetailsImpl` to Spring Security
- Spring Security creates an `Authentication` object
- Calls `OAuth2AuthenticationSuccessHandler.onAuthenticationSuccess()`

---

## Step 9: OAuth2 Success Handler Generates JWT

### ğŸ“ Location
**File:** `/src/main/java/com/learning/security/auth/OAuth2AuthenticationSuccessHandler.java`

### ğŸ“ Code - Success Handler Entry
**Method:** `onAuthenticationSuccess(HttpServletRequest, HttpServletResponse, Authentication)`  
**Lines:** 37-48

```java
@Override
public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
                                    Authentication authentication) throws IOException, ServletException {
    
    String targetUrl = determineTargetUrl(request, response, authentication);

    if (response.isCommitted()) {
        logger.debug("Response has already been committed. Unable to redirect to " + targetUrl);
        return;
    }

    clearAuthenticationAttributes(request);
    getRedirectStrategy().sendRedirect(request, response, targetUrl);
}
```

### ğŸ”„ When Called
- **Automatically by Spring Security** after successful OAuth2 authentication
- Triggered after `CustomOAuth2UserService.loadUser()` completes

### ğŸ“Š Parameter Values
- `request` â†’ HttpServletRequest for the OAuth2 callback
- `response` â†’ HttpServletResponse to send redirect
- `authentication` â†’ Spring Security Authentication object containing:
  ```java
  authentication.getPrincipal() â†’ UserDetailsImpl (from Step 8)
  authentication.isAuthenticated() â†’ true
  authentication.getAuthorities() â†’ [SimpleGrantedAuthority("ROLE_CUSTOMER")]
  ```

### â­ï¸ What Happens Next
- Calls `determineTargetUrl()` to build redirect URL with JWT token

---

### ğŸ“ Code - Determine Target URL
**Method:** `determineTargetUrl(HttpServletRequest, HttpServletResponse, Authentication)`  
**Lines:** 50-75

```java
protected String determineTargetUrl(HttpServletRequest request, HttpServletResponse response,
                                   Authentication authentication) {
    
    // Generate JWT token
    String token = jwtUtils.generateTokenByAuth(authentication);

    // Get user details
    UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();
    String role = userDetails.getAuthorities().iterator().next().getAuthority();

    // Determine target page based on role
    String targetPage;
    if (role.contains("ADMIN")) {
        targetPage = "/admin-panel.html";
    } else if (role.contains("PLANT_MANAGER") || role.contains("MANAGER")) {
        targetPage = "/manager-panel.html";
    } else {
        targetPage = "/customer-dashboard.html";
    }

    // Build redirect URL with token and user info
    return UriComponentsBuilder.fromUriString(targetPage)
            .queryParam("token", token)
            .queryParam("userId", userDetails.getId())
            .queryParam("email", userDetails.getEmail())
            .queryParam("role", role)
            .build().toUriString();
}
```

### ğŸ”„ When Called
- Called by `onAuthenticationSuccess()` method above

### ğŸ“Š Step-by-Step Execution

#### 1. Generate JWT Token
Calls `jwtUtils.generateTokenByAuth(authentication)`

**File:** `/src/main/java/com/learning/security/utils/JwtUtils.java`  
**Method:** `generateTokenByAuth(Authentication auth)`  
**Lines:** 75-93

```java
public String generateTokenByAuth(Authentication auth) {
    
    UserDetailsImpl userDetails = (UserDetailsImpl) auth.getPrincipal();

    return Jwts.builder()
            .header().add("typ", "JWT")
            .and()
            .issuer("M. Yousuf")
            .subject(userDetails.getUsername())  // "m.yousuf@gmail.com"
            .issuedAt(new Date())
            .expiration(new Date(new Date().getTime() + jwtExpirationTimeInMs))
            .signWith(getKey(), Jwts.SIG.HS256)
            .compact();
}
```

**Parameter Values:**
- `auth.getPrincipal()` â†’ `UserDetailsImpl` from Step 8
- `userDetails.getUsername()` â†’ `"m.yousuf@gmail.com"`
- `jwtExpirationTimeInMs` â†’ `86400000` (24 hours from `application-dev.yml`)

**Generated JWT Token:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNLiBZb3VzdWYiLCJzdWIiOiJqb2huLmRvZUBnbWFpbC5jb20iLCJpYXQiOjE3MzQ3ODkxMjAsImV4cCI6MTczNDg3NTUyMH0.dGPOKYZvQ2xm_example_signature
```

**Decoded JWT Payload:**
```json
{
  "iss": "M. Yousuf",
  "sub": "m.yousuf@gmail.com",
  "iat": 1734789120,
  "exp": 1734875520
}
```

#### 2. Extract User Details
```java
UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();
String role = userDetails.getAuthorities().iterator().next().getAuthority();
```

**Values:**
- `userDetails.getId()` â†’ `15`
- `userDetails.getEmail()` â†’ `"m.yousuf@gmail.com"`
- `role` â†’ `"ROLE_CUSTOMER"`

#### 3. Determine Target Page (Role-Based Routing)
```java
String targetPage;
if (role.contains("ADMIN")) {
    targetPage = "/admin-panel.html";
} else if (role.contains("PLANT_MANAGER") || role.contains("MANAGER")) {
    targetPage = "/manager-panel.html";
} else {
    targetPage = "/customer-dashboard.html";
}
```

**Result:** `targetPage = "/customer-dashboard.html"`

#### 4. Build Redirect URL with Query Parameters
```java
return UriComponentsBuilder.fromUriString(targetPage)
        .queryParam("token", token)
        .queryParam("userId", userDetails.getId())
        .queryParam("email", userDetails.getEmail())
        .queryParam("role", role)
        .build().toUriString();
```

**Final Redirect URL:**
```
/customer-dashboard.html?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&userId=15&email=m.yousuf@gmail.com&role=ROLE_CUSTOMER
```

### â­ï¸ What Happens Next
- Returns redirect URL to `onAuthenticationSuccess()`
- Spring Security sends HTTP 302 redirect to browser
- Browser navigates to dashboard with JWT token in URL

---

## Step 10: Browser Receives JWT and Redirects to Dashboard

### ğŸ“ Location
**File:** `/src/main/resources/static/customer-dashboard.html`  
**Lines:** 77-100

### ğŸ“ Code - Extract Token from URL
```javascript
<script>
    const API_BASE = window.location.origin;
    
    // Check for OAuth2 redirect with token in URL
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get('token');
    const urlUserId = urlParams.get('userId');
    const urlEmail = urlParams.get('email');
    const urlRole = urlParams.get('role');

    if (urlToken) {
        // Store OAuth2 token and user info
        localStorage.setItem('jwt_token', urlToken);
        localStorage.setItem('user_id', urlUserId);
        localStorage.setItem('user_email', urlEmail);
        localStorage.setItem('user_role', urlRole);
        
        // Clean URL by removing query parameters
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Fetch and display user details
    fetchUserDetails();
</script>
```

### ğŸ”„ When Called
- Automatically executes when browser loads dashboard page
- Triggered by the redirect from Step 9

### ğŸ“Š Parameter Values Extracted
From URL query parameters:
- `urlToken` â†’ `"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."`
- `urlUserId` â†’ `"15"`
- `urlEmail` â†’ `"m.yousuf@gmail.com"`
- `urlRole` â†’ `"ROLE_CUSTOMER"`

### ğŸ“Š localStorage Values Stored
```javascript
localStorage.setItem('jwt_token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...');
localStorage.setItem('user_id', '15');
localStorage.setItem('user_email', 'm.yousuf@gmail.com');
localStorage.setItem('user_role', 'ROLE_CUSTOMER');
```

### ğŸ“Š Clean URL
```javascript
// Before:
// http://localhost:8080/customer-dashboard.html?token=eyJ...&userId=15&email=m.yousuf@gmail.com&role=ROLE_CUSTOMER

// After replaceState:
// http://localhost:8080/customer-dashboard.html
```

### â­ï¸ What Happens Next
- Token stored in localStorage for future API requests
- User sees their dashboard
- **OAuth2 flow complete! ğŸ‰**

---

## ğŸ”„ Complete Flow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User clicks "Sign in with Google" button                     â”‚
â”‚    Location: login.html â†’ loginWithGoogle()                     â”‚
â”‚    Action: window.location.href = "/oauth2/authorize/google"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Browser sends GET /oauth2/authorize/google                   â”‚
â”‚    Spring Security intercepts request                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. WebSecurityConfig processes OAuth2 login request             â”‚
â”‚    Location: WebSecurityConfig.java â†’ oauth2Login()             â”‚
â”‚    Reads configuration from application-dev.yml                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Spring redirects to Google OAuth2 authorization URL          â”‚
â”‚    URL: https://accounts.google.com/o/oauth2/v2/auth            â”‚
â”‚    Parameters: client_id, redirect_uri, scope, state            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. User authenticates with Google (External)                    â”‚
â”‚    - Selects Google account                                     â”‚
â”‚    - Grants permissions (email, profile)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Google redirects back with authorization code                â”‚
â”‚    URL: /login/oauth2/code/google?code=...&state=...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Spring exchanges authorization code for access token         â”‚
â”‚    POST https://oauth2.googleapis.com/token                     â”‚
â”‚    Response: { access_token, id_token, expires_in }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. CustomOAuth2UserService.loadUser() called                    â”‚
â”‚    Location: CustomOAuth2UserService.java                       â”‚
â”‚    Method: loadUser(OAuth2UserRequest)                          â”‚
â”‚    - Calls super.loadUser() to fetch Google user data           â”‚
â”‚    - Returns OAuth2User with attributes                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. processOAuth2User() extracts user information                â”‚
â”‚    Method: processOAuth2User(userRequest, oAuth2User)           â”‚
â”‚    - Calls getOAuth2UserInfo() â†’ GoogleOAuth2UserInfo           â”‚
â”‚    - Extracts: id, name, email, imageUrl                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Check if user exists in database                            â”‚
â”‚     Query: userRepo.findByEmail(email)                          â”‚
â”‚     â”œâ”€ User EXISTS â”€â”€â”€â”€â–º updateExistingUser()                   â”‚
â”‚     â””â”€ User NOT EXISTS â–º registerNewUser() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. registerNewUser() creates database entry                    â”‚
â”‚     Method: registerNewUser(userRequest, oAuth2UserInfo)        â”‚
â”‚     - Creates new User entity                                   â”‚
â”‚     - Sets provider: GOOGLE, providerId: <sub>                  â”‚
â”‚     - Assigns default role: ROLE_CUSTOMER                       â”‚
â”‚     - SQL: INSERT INTO users (email, provider, role_id...)      â”‚
â”‚     - Returns saved User with auto-generated ID                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. UserDetailsImpl.build(user, attributes) creates principal   â”‚
â”‚     Location: UserDetailsImpl.java                              â”‚
â”‚     Method: build(User user, Map<String, Object> attributes)    â”‚
â”‚     - Converts User entity to Spring Security UserDetails       â”‚
â”‚     - Sets authorities: [SimpleGrantedAuthority("ROLE_CUSTOMER")]â”‚
â”‚     - Returns UserDetailsImpl object                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. Spring Security creates Authentication object               â”‚
â”‚     - Principal: UserDetailsImpl                                â”‚
â”‚     - Authenticated: true                                       â”‚
â”‚     - Authorities: [ROLE_CUSTOMER]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. OAuth2AuthenticationSuccessHandler.onAuthenticationSuccess()â”‚
â”‚     Location: OAuth2AuthenticationSuccessHandler.java           â”‚
â”‚     Method: onAuthenticationSuccess(request, response, auth)    â”‚
â”‚     - Calls determineTargetUrl()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. determineTargetUrl() generates JWT and builds redirect URL  â”‚
â”‚     Method: determineTargetUrl(request, response, auth)         â”‚
â”‚     â”œâ”€ jwtUtils.generateTokenByAuth(auth)                       â”‚
â”‚     â”‚  â””â”€â–º JWT Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...   â”‚
â”‚     â”œâ”€ Extract role: "ROLE_CUSTOMER"                            â”‚
â”‚     â”œâ”€ Determine page: "/customer-dashboard.html"               â”‚
â”‚     â””â”€ Build URL: /customer-dashboard.html?token=...&userId=... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 16. Send HTTP 302 redirect to browser                           â”‚
â”‚     Response: Location: /customer-dashboard.html?token=...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 17. Browser navigates to dashboard with token in URL            â”‚
â”‚     Location: customer-dashboard.html                           â”‚
â”‚     JavaScript executes on page load                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 18. Extract token from URL parameters                           â”‚
â”‚     const urlToken = urlParams.get('token');                    â”‚
â”‚     const urlUserId = urlParams.get('userId');                  â”‚
â”‚     const urlEmail = urlParams.get('email');                    â”‚
â”‚     const urlRole = urlParams.get('role');                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 19. Store token and user info in localStorage                   â”‚
â”‚     localStorage.setItem('jwt_token', urlToken);                â”‚
â”‚     localStorage.setItem('user_id', urlUserId);                 â”‚
â”‚     localStorage.setItem('user_email', urlEmail);               â”‚
â”‚     localStorage.setItem('user_role', urlRole);                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 20. Clean URL and display dashboard                             â”‚
â”‚     window.history.replaceState({}, '', window.location.pathname)â”‚
â”‚     fetchUserDetails() - loads user profile from API            â”‚
â”‚                                                                  â”‚
â”‚     âœ… USER SUCCESSFULLY LOGGED IN WITH OAUTH2! âœ…               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Key Data Structures

### Google OAuth2 User Attributes
```json
{
  "sub": "117355461831405973524",
  "name": "M. Yousuf",
  "given_name": "M. ",
  "family_name": "Yousuf",
  "picture": "https://lh3.googleusercontent.com/a/...",
  "email": "m.yousuf@gmail.com",
  "email_verified": true,
  "locale": "en"
}
```

### User Entity (Database)
```java
User {
    id: 15                                    // Auto-generated
    email: "m.yousuf@gmail.com"
    password: ""                              // Empty for OAuth2
    provider: AuthProvider.GOOGLE
    providerId: "117355461831405973524"      // Google's "sub"
    imageUrl: "https://lh3.googleusercontent.com/..."
    emailVerified: true
    isLocked: false
    role: Role {
        id: 3
        name: "ROLE_CUSTOMER"
    }
}
```

### UserDetailsImpl (Spring Security Principal)
```java
UserDetailsImpl {
    id: 15
    username: "m.yousuf@gmail.com"
    email: "m.yousuf@gmail.com"
    password: ""
    active: true
    isLocked: false
    attributes: { /* Google OAuth2 attributes */ }
    roles: [SimpleGrantedAuthority("ROLE_CUSTOMER")]
}
```

### Authentication Object (Spring Security)
```java
OAuth2AuthenticationToken {
    principal: UserDetailsImpl (above)
    credentials: null
    authenticated: true
    authorities: [SimpleGrantedAuthority("ROLE_CUSTOMER")]
    details: WebAuthenticationDetails
}
```

### JWT Token Structure
```
Header:
{
  "typ": "JWT",
  "alg": "HS256"
}

Payload:
{
  "iss": "M. Yousuf",
  "sub": "m.yousuf@gmail.com",
  "iat": 1734789120,
  "exp": 1734875520
}

Signature:
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret_key
)
```

---

## ğŸ” Function Call Chain with Parameters

```
1. login.html: loginWithGoogle()
   â””â”€â–º Redirects to: /oauth2/authorize/google

2. Spring Security: OAuth2AuthorizationRequestRedirectFilter
   â””â”€â–º Reads config from: application-dev.yml
   â””â”€â–º Redirects to: https://accounts.google.com/o/oauth2/v2/auth?client_id=...

3. Google OAuth2 Server (External)
   â””â”€â–º User authenticates
   â””â”€â–º Redirects to: /login/oauth2/code/google?code=<auth_code>&state=<state>

4. Spring Security: OAuth2LoginAuthenticationFilter
   â””â”€â–º POST https://oauth2.googleapis.com/token
       Parameters: {
           code: "<auth_code>",
           client_id: "147705378900-...",
           client_secret: "GOCSPX-...",
           redirect_uri: "http://localhost:8080/login/oauth2/code/google",
           grant_type: "authorization_code"
       }
   â””â”€â–º Receives: { access_token, id_token, expires_in }

5. Spring Security: DefaultOAuth2UserService.loadUser()
   â””â”€â–º GET https://www.googleapis.com/oauth2/v3/userinfo
       Headers: { Authorization: "Bearer <access_token>" }
   â””â”€â–º Returns: OAuth2User with attributes

6. CustomOAuth2UserService.loadUser(OAuth2UserRequest userRequest)
   Parameters:
       userRequest.getAccessToken() = "<access_token>"
       userRequest.getClientRegistration().getRegistrationId() = "google"
   â””â”€â–º Calls: super.loadUser(userRequest)
       Returns: OAuth2User with Google attributes
   
   â””â”€â–º Calls: processOAuth2User(userRequest, oAuth2User)
       Parameters:
           userRequest = OAuth2UserRequest
           oAuth2User = OAuth2User { attributes: {...} }

7. processOAuth2User(OAuth2UserRequest userRequest, OAuth2User oAuth2User)
   
   â””â”€â–º Calls: getOAuth2UserInfo("google", oAuth2User.getAttributes())
       Parameters:
           registrationId = "google"
           attributes = { sub, name, email, picture, ... }
       Returns: GoogleOAuth2UserInfo
   
   â””â”€â–º Calls: userRepo.findByEmail("m.yousuf@gmail.com")
       Returns: Optional.empty() (user doesn't exist)
   
   â””â”€â–º Calls: registerNewUser(userRequest, oAuth2UserInfo)
       Parameters:
           userRequest = OAuth2UserRequest
           oAuth2UserInfo = GoogleOAuth2UserInfo {
               id: "117355461831405973524",
               name: "M. Yousuf",
               email: "m.yousuf@gmail.com",
               imageUrl: "https://lh3.googleusercontent.com/..."
           }

8. registerNewUser(OAuth2UserRequest userRequest, OAuth2UserInfo oAuth2UserInfo)
   
   â””â”€â–º Calls: roleRepo.findByName("ROLE_CUSTOMER")
       Returns: Role { id: 3, name: "ROLE_CUSTOMER" }
   
   â””â”€â–º Calls: userRepo.save(user)
       Parameters: User {
           email: "m.yousuf@gmail.com",
           provider: GOOGLE,
           providerId: "117355461831405973524",
           role: Role(id=3),
           ...
       }
       Database INSERT executed
       Returns: User { id: 15, ... }
   
   â””â”€â–º Returns: User { id: 15 }

9. processOAuth2User() continues:
   â””â”€â–º Calls: UserDetailsImpl.build(user, oAuth2User.getAttributes())
       Parameters:
           user = User { id: 15, email: "m.yousuf@gmail.com", ... }
           attributes = { sub, name, email, picture, ... }
       Returns: UserDetailsImpl {
           id: 15,
           username: "m.yousuf@gmail.com",
           roles: [SimpleGrantedAuthority("ROLE_CUSTOMER")],
           attributes: {...}
       }

10. Spring Security creates Authentication object
    authentication = OAuth2AuthenticationToken {
        principal: UserDetailsImpl,
        authenticated: true,
        authorities: [ROLE_CUSTOMER]
    }

11. OAuth2AuthenticationSuccessHandler.onAuthenticationSuccess(request, response, authentication)
    Parameters:
        request = HttpServletRequest
        response = HttpServletResponse
        authentication = OAuth2AuthenticationToken (from step 10)
    
    â””â”€â–º Calls: determineTargetUrl(request, response, authentication)

12. determineTargetUrl(HttpServletRequest request, HttpServletResponse response, Authentication authentication)
    
    â””â”€â–º Calls: jwtUtils.generateTokenByAuth(authentication)
        Parameters:
            authentication = OAuth2AuthenticationToken
            authentication.getPrincipal() = UserDetailsImpl {
                id: 15,
                username: "m.yousuf@gmail.com"
            }
        Returns: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    
    â””â”€â–º Extracts:
        userDetails = (UserDetailsImpl) authentication.getPrincipal()
        role = "ROLE_CUSTOMER"
    
    â””â”€â–º Determines:
        targetPage = "/customer-dashboard.html"
    
    â””â”€â–º Builds URL:
        UriComponentsBuilder.fromUriString("/customer-dashboard.html")
            .queryParam("token", "eyJhbGci...")
            .queryParam("userId", 15)
            .queryParam("email", "m.yousuf@gmail.com")
            .queryParam("role", "ROLE_CUSTOMER")
        Returns: "/customer-dashboard.html?token=eyJhbGci...&userId=15&email=m.yousuf@gmail.com&role=ROLE_CUSTOMER"

13. onAuthenticationSuccess() continues:
    â””â”€â–º Calls: getRedirectStrategy().sendRedirect(request, response, targetUrl)
        Parameters:
            targetUrl = "/customer-dashboard.html?token=...&userId=15&..."
        Effect: Sends HTTP 302 redirect to browser

14. Browser receives redirect and navigates to customer-dashboard.html

15. customer-dashboard.html JavaScript executes:
    URLSearchParams extracts:
        urlToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        urlUserId = "15"
        urlEmail = "m.yousuf@gmail.com"
        urlRole = "ROLE_CUSTOMER"
    
    localStorage stores:
        jwt_token = "eyJhbGci..."
        user_id = "15"
        user_email = "m.yousuf@gmail.com"
        user_role = "ROLE_CUSTOMER"
    
    URL cleaned: /customer-dashboard.html
    
    Dashboard displays user information
```

---

## ğŸ¯ Quick Reference: When Functions Are Called

| Function | Called By | Trigger | Parameters | Returns |
|----------|-----------|---------|------------|---------|
| `loginWithGoogle()` | User click | Button click | None | Redirects browser |
| `loadUser(OAuth2UserRequest)` | Spring Security | After token exchange | `userRequest` | `OAuth2User` |
| `processOAuth2User()` | `loadUser()` | Internal | `userRequest`, `oAuth2User` | `OAuth2User` |
| `getOAuth2UserInfo()` | `processOAuth2User()` | Internal | `"google"`, `attributes` | `GoogleOAuth2UserInfo` |
| `registerNewUser()` | `processOAuth2User()` | New user detected | `userRequest`, `oAuth2UserInfo` | `User` (saved) |
| `updateExistingUser()` | `processOAuth2User()` | Existing user detected | `existingUser`, `oAuth2UserInfo` | `User` (updated) |
| `UserDetailsImpl.build()` | `processOAuth2User()` | After user saved/updated | `user`, `attributes` | `UserDetailsImpl` |
| `onAuthenticationSuccess()` | Spring Security | After successful auth | `request`, `response`, `authentication` | Redirects |
| `determineTargetUrl()` | `onAuthenticationSuccess()` | Internal | `request`, `response`, `authentication` | Redirect URL |
| `generateTokenByAuth()` | `determineTargetUrl()` | Internal | `authentication` | JWT token string |

---

## ğŸ“ Notes

### Environment Variables Required
```bash
export GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
export GOOGLE_CLIENT_SECRET=GOCSPX-your-client-secret-here
```

### Database Prerequisites
- `ROLE_CUSTOMER` must exist in `role` table
- Recommended: Run `insert_roles_and_admin.sql` to populate roles

### Google Console Configuration
- **Authorized redirect URI:** `http://localhost:8080/login/oauth2/code/google`
- **Authorized JavaScript origins:** `http://localhost:8080`

### Token Expiration
- JWT expires after 24 hours (`86400000` ms from `application-dev.yml`)
- Google access token expires after ~1 hour (handled by Spring Security)

---

## ğŸ”§ Debugging Tips

### Check if OAuth2 is working:
1. Open browser console (F12)
2. Click "Sign in with Google"
3. Monitor Network tab for redirects:
   - `/oauth2/authorize/google` â†’ 302 to Google
   - Google login â†’ 302 back to `/login/oauth2/code/google`
   - `/login/oauth2/code/google` â†’ 302 to dashboard

### Verify database entry:
```sql
SELECT * FROM users WHERE email = 'm.yousuf@gmail.com';
SELECT * FROM role WHERE name = 'ROLE_CUSTOMER';
```

### Check JWT token:
1. Copy token from localStorage in browser console
2. Paste into https://jwt.io/
3. Verify payload contains correct email and expiration

### Common Issues:
- **"OAuth client was not found"** â†’ Environment variables not set
- **"Role is not found"** â†’ Run `insert_roles_and_admin.sql`
- **Redirect URI mismatch** â†’ Update Google Console settings
- **Token not stored** â†’ Check browser console for JavaScript errors

---

**Documentation created:** December 21, 2025  
**Author:** M. Yousuf 
**Spring Boot Version:** 3.4.1  
**Spring Security Version:** 6.x
